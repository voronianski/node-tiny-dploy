#!/usr/bin/env node

var cli = require('commander');
var deployer = require('../');

cli.version(deployer.version);

cli
	.command('reload')
	.description('Reload instance silently without shooting off')
	.action(function (instance) {
		if (typeof instance !== 'string') {
			console.info('Usage: dploy reload [app]');
			process.exit(0);
		}
		return deployer.reload(instance);
	});

cli
	.command('restart')
	.description('Force pm2 stopping/restarting an instance')
	.action(function (instance) {
		if (typeof instance !== 'string') {
			console.info('Usage: dploy restart [app]');
			process.exit(0);
		}
		return deployer.restart(instance);
	});

cli
	.command('setup')
	.description('Setup new instance and start it with pm2')
	.action(function () {
		cli.prompt({
			name: 'name: ',
			git: 'git url: ',
			branch: 'git branch (master): ',
			node: 'node (app.js): ',
			folder: 'folder in /var/www/ : ',
			pm2: 'pm2 process: ',
			opts: 'pm2 opts: ',
			node_env: 'NODE_ENV (development): ',
			port: 'NODE_PORT (80): '
		}, function (cfg) {
			if (!cfg.name) {
				console.error('Error: Instance name is required');
				return process.exit(1);
			}
			if (!cfg.git) {
				console.error('Error: git repository url is required');
				return process.exit(1);
			}

			cfg.node = cfg.node || 'app.js';
			cfg.branch = cfg.branch || 'master';

			return deployer.create(cfg);
		});
	});

cli
	.command('list')
	.description('List available instances')
	.action(function () {
		return deployer.list();
	});

cli
	.command('remove')
	.description('Delete application folder and config entry')
	.action(function (instance) {
		if (typeof instance !== 'string') {
			console.info('Usage: dploy remove [app]');
			process.exit(0);
		}
		cli.prompt({
			val: 'Are you sure you want to delete ['+instance+']? (y/N) '
		}, function (obj) {
			if (obj.val === 'y' || obj.val === 'Y') {
				return deployer.remove(instance);
			}
			return process.exit(0);
		});
	});

cli.parse(process.argv);
